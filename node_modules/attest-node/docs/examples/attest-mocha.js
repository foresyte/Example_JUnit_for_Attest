var selenium = require('selenium-webdriver');
var AttestBuilder = require('attest-webdriverjs');
var attest = require('../../index')();
var assert = require('chai').assert;


describe('Attest-reporter Tutorial', function() {
    var driver;
    var testResultRoot = './a11y-results';

    // Load the driver
    before(function() {
        driver = new selenium.Builder().forBrowser('firefox').build();
        driver.manage().timeouts().setScriptTimeout(10000);
    });

    // Close the driver at the end
    after(function(done) {
        driver.quit().then(done);
    });

    describe('deque.com', function (done) {

        // Tell the reporter under what name and where to store results
        var reporter;
        before(function () {
            reporter = attest.report('deque.com site', testResultRoot);
        });

        it('has 0 accessibility violations on root', function (done) {
            driver.get('http://www.deque.com/')
            .then(includeAttest('wcag2', function (attest) {
                attest.analyze(function(results) {
                    // Store the results for the homepage
                    reporter.logTestResult('homepage', results);
                    assert(results.violations.length === 0);
                    done();
                });
            }));
        });

        it('has 0 accessibility violations on about', function (done) {
            driver.get('http://www.deque.com/about-us/')
            .then(includeAttest('wcag2', function (attest) {
                attest.analyze(function(results) {
                    // Store the results for the about-us page
                    reporter.logTestResult('about', results);
                    assert(results.violations.length === 0);
                    done();
                });
            }));
        });
    });

    describe('dequeuniversity.com', function (done) {

        // Tell the reporter under what name and where to store results
        var reporter;
        before(function () {
            reporter = attest.report('dequeuniversity.com site', testResultRoot);
        });

        it('has 0 accessibility violations on root', function (done) {
            driver.get('https://dequeuniversity.com/')
            .then(includeAttest('wcag2', function (attest) {
                attest.analyze(function(results) {
                    // Store the results for the homepage
                    reporter.logTestResult('homepage', results);
                    assert(results.violations.length === 0);
                    done();
                });
            }));
        });

        it('has 0 accessibility violations on contact', function (done) {
            driver.get('https://dequeuniversity.com/contact/')
            .then(includeAttest('wcag2', function (attest) {
                attest.analyze(function(results) {
                    // Store the results for the contact-us page
                    reporter.logTestResult('contact', results);
                    assert(results.violations.length === 0);
                    done();
                });
            }));
        });
    });


    /**
     * Returns a promise indicating when attest is ready to test the page
     */
    function includeAttest(standard, callback) {
        return driver.executeAsyncScript(function(callback) {
            var script = document.createElement('script');
            script.innerHTML = 'document.documentElement.classList.add("deque-attest-is-ready");';
            document.documentElement.appendChild(script);
            callback();

        }).then(function () {
            return driver.wait(selenium.until.elementsLocated(selenium.By.css('.deque-attest-is-ready')));

        }).then(function () {
            callback(new AttestBuilder(driver, standard));

        });
    }

});
